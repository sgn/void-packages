# Template file for 'bazel-bootstrap'
pkgname=bazel-bootstrap
version=7.0.2
revision=1
hostmakedepends="protobuf python3 unzip openjdk11 which perl grpc zip tar"
makedepends="protobuf-devel libprotoc-devel grpc-devel libarchive-devel
 zlib-devel"
depends="openjdk11"
short_desc="Fast, scalable, multi-language and extensible build system"
maintainer="Đoàn Trần Công Danh <congdanhqx@gmail.com>"
license="Apache-2.0"
homepage="https://bazel.build/"
distfiles="https://github.com/bazelbuild/bazel/releases/download/${version}/bazel-${version}-dist.zip"
checksum=dea2b90575d43ef3e41c402f64c2481844ecbf0b40f8548b75a204a4d504e035
nostrip=yes
python_version=3

nocross=yes

case "$XBPS_TARGET_MACHINE" in
	aarch64*) _cpu=aarch64 ;;
	armv7*) _cpu=armv7 ;;
	arm*) _cpu=arm ;;
	x86_64*) _cpu=x86_64 ;;
	i686*) _cpu=i386 ;;
	ppc64le*) _cpu=ppc64le ;;
	ppc64*) _cpu=ppc ;;
	ppc*) _cpu=ppc32 ;;
	riscv64*) _cpu=riscv64 ;;
	*) broken="not supported" ;;
esac

do_build() {
	local flag
	local _bazel_opts="-s --verbose_failures"
	for flag in $CFLAGS; do
		_bazel_opts+=" --conlyopt=$flag"
		# For -fstack-protector ...
		_bazel_opts+=" --linkopt=$flag"
	done
	for flag in $CXXFLAGS; do
		_bazel_opts+=" --cxxopt=$flag"
		_bazel_opts+=" --linkopt=$flag"
	done
	for flag in $LDFLAGS; do
		_bazel_opts+=" --linkopt=$flag"
	done

	_bazel_opts+=" --define=enable_distributions=debian"
	_bazel_opts+=" --compilation_mode=opt"
	_bazel_opts+=" --action_env=PATH"
	_bazel_opts+=" --java_runtime_version=local_jdk"
	_bazel_opts+=" --tool_java_runtime_version=local_jdk"

	export JAVA_HOME="/usr/lib/jvm/openjdk11"

	EMBED_LABEL=${version} \
	EXTRA_BAZEL_ARGS="$_bazel_opts" \
	./compile.sh
	chmod -R u+rwX /tmp
}

do_install() {
	vbin output/bazel
}
