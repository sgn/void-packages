# Template file for 'cryfs'
pkgname=cryfs
version=0.11.2
revision=1
create_wrksrc=yes
build_style=cmake
configure_args="-DBoost_USE_STATIC_LIBS=OFF -DBUILD_TESTING=OFF
 -DCRYFS_UPDATE_CHECKS=OFF
 -DDEPENDENCY_CONFIG=../cmake-utils/DependenciesFromLocalSystem.cmake"
hostmakedepends="pkg-config python3 range-v3"
makedepends="boost-devel crypto++-devel fmt-devel fuse-devel libcurl-devel
 libgomp-devel spdlog"
depends="fuse"
short_desc="Cryptographic filesystem for the cloud"
maintainer="Andy Weidenbaum <atweiden@tutanota.de>"
license="LGPL-3.0-only"
homepage="https://www.cryfs.org"
changelog="https://github.com/cryfs/cryfs/raw/master/ChangeLog.txt"
distfiles="https://github.com/cryfs/cryfs/releases/download/${version}/${pkgname}-${version}.tar.xz"
checksum=951ef565d37521df5586b00ed898f1cb76188739c27b9db866cc91ca14fdf1bd

CXX_FLAGS="-pthread"

if [ "${XBPS_CHECK_PKGS}" ]; then
	configure_args+=" -DBUILD_TESTING=on"
fi

post_patch() {
	rm -rf vendor/cryptopp
	rm -rf vendor/spdlog
}

pre_configure() {
	local _pkg_config="$($PKG_CONFIG --cflags spdlog)"
	CFLAGS+=" $_pkg_config"
	CXXFLAGS+=" $_pkg_config"
}

do_check() {
	cd ${wrksrc}/build
	# XXX: check their Travis-CI script on update
	./test/gitversion/gitversion-test
	./test/cpp-utils/cpp-utils-test
	./test/parallelaccessstore/parallelaccessstore-test
	./test/blockstore/blockstore-test
	./test/blobstore/blobstore-test
	./test/cryfs/cryfs-test
	# can't be run inside chroot due to fusermount
	#./test/fspp/fspp-test
	#./test/cryfs-cli/cryfs-cli-test
}
