# Template file for 'bazel'
pkgname=bazel
version=7.0.2
revision=1
hostmakedepends="protobuf python3 unzip openjdk11 which perl grpc zip tar
 bazel-bootstrap"
makedepends="protobuf-devel libprotoc-devel grpc-devel libarchive-devel
 zlib-devel"
depends="openjdk11"
short_desc="Fast, scalable, multi-language and extensible build system"
maintainer="Đoàn Trần Công Danh <congdanhqx@gmail.com>"
license="Apache-2.0"
homepage="https://bazel.build/"
distfiles="https://github.com/bazelbuild/bazel/releases/download/${version}/bazel-${version}-dist.zip"
checksum=477e54f6374001f439a9471ba1de9d7824daf129db95510849ecc5e19ce88170
checksum=dea2b90575d43ef3e41c402f64c2481844ecbf0b40f8548b75a204a4d504e035
nostrip=yes
python_version=3

nocross="not tried yet, unsure about ijar and protoc"

do_configure() {
	cp scripts/bootstrap/BUILD.bootstrap \
		scripts/bootstrap/BUILD
}

do_build() {
	local flag
	local _bazel_opts="-s --verbose_failures"
	for flag in $CFLAGS; do
		_bazel_opts+=" --conlyopt=$flag"
		# For -fstack-protector ...
		_bazel_opts+=" --linkopt=$flag"
	done
	for flag in $CXXFLAGS; do
		_bazel_opts+=" --cxxopt=$flag"
		_bazel_opts+=" --linkopt=$flag"
	done
	for flag in $LDFLAGS; do
		_bazel_opts+=" --linkopt=$flag"
	done

	_bazel_opts+=" --define=enable_distributions=debian"
	_bazel_opts+=" --compilation_mode=opt"
	_bazel_opts+=" --action_env=PATH"

	export JAVA_HOME="/usr/lib/jvm/openjdk11"
	bazel build $_bazel_opts \
		--extra_toolchains=//scripts/bootstrap:all \
		--javacopt="-g -source 11 -target 11" \
		--java_runtime_version=local_jdk \
		--tool_java_runtime_version=local_jdk \
		--stamp --embed_label "$version" \
		--strategy=Javac=worker --worker_quit_after_build \
		--ignore_unsupported_sandboxing \
		--nojava_header_compilation \
		src:bazel_nojdk
	# scripts:bazel-complete.bash and scripts:fish_completion
	# seems to requires bazel_remotejdk which is problematic on musl
	#
	# ./output/bazel build //scripts:bazel-complete.bash
	# ./output/bazel build //scripts:fish_completion
	# ./output/bazel shutdown
	chmod -R u+rwX /tmp
}

do_install() {
	vbin scripts/packages/bazel.sh bazel
	vinstall bazel-bin/src/bazel_nojdk 755 \
		usr/libexec/bazel bazel-real
	vcompletion scripts/zsh_completion/_bazel zsh
	vmkdir usr/share/example/bazel
	vcopy "examples/*" usr/share/example/bazel
	vmkdir usr/share/bazel
	vcopy third_party usr/share/bazel
	vcopy tools usr/share/bazel
}
